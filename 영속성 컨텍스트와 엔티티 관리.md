### 영속성 컨텍스트

- 엔티티를 영구 저장하는 환경
- JPA가 엔티티를 기반으로 데이터를 처리하는 데 있어서 핵심 역할을 하는 객체

- 메타데이터를 참조하여 애플리케이션 운용에 필요한 객체를 생성하고 관리하는 객체 persistence.xml 파일을 로딩하여 만들어진다.

- 영속성 컨텍스트는 EntityManager 객체를 생성할 때 자동으로 생성되며, 오로지 EntityManager 가 제공하는 메소드를 통해서만 접근할 수 있다.

- 영속성 컨텍스트가 관리하는 엔티티는 생성(NEW), 관리(MANAGED), 분리(DETACHED), 삭제(REMOVED) 같은 4가지 상태로 존재할 수 있다.

  ![다운로드](https://user-images.githubusercontent.com/50399804/120799969-610f3280-c57a-11eb-8762-b44bd8129b69.png)

  | 상태            | 의미                                                                 |
  | --------------- | -------------------------------------------------------------------- |
  | 생성(NEW)       | 엔티티가 영속 컨테이너에 등록되지 않은 상태                          |
  | 관리(MANAGED)   | 엔티티가 영속 컨테이너에 등록된 상태                                 |
  | 분리(DETATCHED) | 엔티티가 한 번 영속 컨테이너에 등록되었다가 컨테이너에서 분리된 상태 |
  | 삭제(REMOVED)   | 엔티티가 영속 컨테이너에서 삭제 처리된 상태                          |

---

<br>

#### 생성 상태(NEW)

- 비영속 상태라고도 하며, 단지 엔티티 객체를 생성만 했을 뿐 아직 영속 컨테이너에 등록하지 않은 상태

```java
// 엔티티 생성 및 초기화
Employee employee = new Employee
employee.setName("둘리");
```

<br>

![제목 없음](https://user-images.githubusercontent.com/50399804/120801168-c9aadf00-c57b-11eb-82e1-9a3e38cfbaca.png)

- 생성 상태의 엔티티는 아직 영속 컨테이너에 등록되지 않은 상태이므로, 영속 컨테이너에 의해 관리되지 않을뿐더러 데이터베이스와도 연관이 없다.

---

#### 관리 상태(MANAGED)

- 영속 상태라고도 하며, 엔티티가 영속 컨테이너의 관리를 받고 있는 상태, 영속 컨테이너가 엔티티 객체를 관리하기 위해서는 엔티티 객체를 당연히 등록해야 한다.

- 엔티티를 영속 컨테이너에 등록하여 관리 상태로 전환하는 방법으로는 2가지가 있다.

  - EntityManager.persist

    - 테이블에 실제 Insert가 발생하기 위해서는 persist 메소드 호출이 반드시 트랜잭션 안에서 이루어져야 한다. 트랜잭션이 종료되는 시점에 실질적인 INSERT가 데이터베이스에 전송된다.

    - 관리중인 엔티티의 상태가 변경되는 순간, 변경을 감지하여 데이터베이스에 UPDATE를 처리해 준다. (더티 체킹)

    ![제목 없음](https://user-images.githubusercontent.com/50399804/120801603-535aac80-c57c-11eb-81e7-562b97e06e36.png)

- EntityManager.find

  - 엔티티를 관리 상태로 만들기 위해, 검색 기능인 find 메소드를 사용할 수도 있다.

  - 조회하고자 하는 엔티티가 영속 컨테이너에 존재하면 엔티티를 반환하고, 없으면 데이터베이스에서 데이터를 조회하여 새로운 엔티티를 생성한다.

  - 그리고 생성한 엔티티를 영속 컨테이너에 등록하고 나서 클라이언트로 반환한다.

    ![img](https://user-images.githubusercontent.com/50399804/120802313-468a8880-c57d-11eb-88de-5f444f6c591a.png)

---

#### 분리 상태(DETACHED)

- 준영속 상태라고도 하며, 영속 컨테이너에 있던 엔티티가 특정 작업에 의해 영속 컨테이너에서 벗어난 상태를 의미한다. 분리 상태의 엔티티는 영속 컨테이너의 통제에서 벗어나기 때문에 영속 컨테이너가 엔티티의 상태를 관리하지 못한다. (더티 체킹이 일어나지 않음)

- 영속 컨테이너를 벗어난 상태라는 점에서 분리 상태를 생성 상태와 비슷하다고 생각할 수 있지만 그렇지 않다. 두 상태를 구분하는 가장 중요한 기준은 식별자 값의 유무라고 할 수 있다.

- 생성 상태의 경우, 관리 상태로 전환된 적이 없으므로 식별자 값을 가지지 않지만 분리 상태는 한 번 관리 상태로 전환된 적이 있으므로 영속 컨테이너를 벗어났기 때문에 반드시 식별자 값을 가진다.

  ![제목 없음](https://user-images.githubusercontent.com/50399804/120803096-2a3b1b80-c57e-11eb-9566-16236dc23756.png)

  | 메소드         | 의미                                                                                                                |
  | -------------- | ------------------------------------------------------------------------------------------------------------------- |
  | detach(entity) | 특정 엔티티만 분리 상태로 전환한다.                                                                                 |
  | clear()        | 영속 컨테이너를 초기화한다. 이때 영속 컨테이너가 관리하던 모든 엔티티들을 분리 상태로 전환한다.                     |
  | close()        | 영속 컨테이너를 종료한다. 영속 컨테이너는 종료되기 직전에 컨테이너가 관리하던 모든 엔티티들을 분리 상태로 전환한다. |

---

#### 삭제 상태(REMOVED)

- 엔티티가 영속 컨테이너에서 제거된 상태를 의미한다. 제거된 엔티티에 대해서 트랜잭션이 종료되는 시점(tx.commit())에 실제 데이터베이스에서도 데이터가 삭제된다.

---

### 영속 컨테이너와 엔티티 캐시

- 영속 컨테이너는 왜 persist 메소드를 호출했을 때 관련된 SQL을 바로 처리하지 않을까? 이점은 무엇일까

<br>

#### 등록과 엔티티 캐시

- JPA는 영속 컨테이너 내부에 엔티티 캐시(cache)라는 저장 공간을 만들어서 엔티티들을 관리한다. key,value 를 쌍으로 엔티티들을 저장하고 관리하는 일종의 java.util.Map 과 같은 컬렉션

  ![img (1)](https://user-images.githubusercontent.com/50399804/120804755-fcef6d00-c57f-11eb-9f57-f0fd190b9b5e.png)

- persist 메소드 기능이 엔티티를 캐시에 등록하는 것에 한정이 되어 있고, 영속 컨테이너가 캐시에 등록된 엔티티에 대해서 INSERT 까지 처리하도록 하려면 반드시 캐시에 대한 플러시(FLUSH)가 실행되어야 한다.

  ![04_transactional_write_behind](https://user-images.githubusercontent.com/50399804/120806308-aa16b500-c581-11eb-8be0-9ffc8465c7fe.png)

- 플러시는 저장된 엔티티의 상태 변화를 데이터베이스에 반영하는 동기화 과정으로 이해하면 된다.

- 플러시가 발생하는 경우는 총 3가지

  - EntityManager 의 flush 메소드 호출
  - 트랜잭션을 커밋하여 내부적으로 플러시
  - JPQL 을 이용하여 쿼리를 실행하기 직전 자동으로 플러시

- 플러시가 실행되면 영속 컨테이너는 캐시에 등록된 모든 엔티티들의 상태를 체크하여 SQL 구문을 만든다. 생성된 SQL 구문들을 개별적으로 데이터베이스에서 전송하는 것이 아니라 한 번의 연결로 처리한다.

- 여러 건의 데이터에 대하여 등록/수정/삭제할 때도 효울적이지만 일반적으로는 검색 기능을 처리할 때 매우 유용하다.

  ![img](https://user-images.githubusercontent.com/50399804/120802313-468a8880-c57d-11eb-88de-5f444f6c591a.png)
